#!/bin/bash
set -eu

cd "$(dirname "$0")"

# Source Nix environment if available
if [ -e /etc/profile.d/nix.sh ]; then
	source /etc/profile.d/nix.sh
fi

# Build using Nix flake (enable experimental features for flakes and nix-command)
nix --extra-experimental-features 'nix-command flakes' build

# Copy binaries from Nix store to current directory
for prog in result/bin/*; do
	if [ -f "$prog" ]; then
		progname=$(basename "$prog")
		cp -f "$prog" ./"$progname"
		chmod +x "./$progname"
	fi
done

# Copy built web resources (only artifacts, not source files from submodules)
if [ -d result/share/dfeed/web ]; then
	echo "Copying built web resources..."

	# Copy built template files
	cp -f result/share/dfeed/web/*.htt ./web/ 2>/dev/null || true

	# Copy built dfeed CSS/JS
	mkdir -p web/static/css web/static/js
	cp -f result/share/dfeed/web/static/css/*.min.css ./web/static/css/ 2>/dev/null || true
	cp -f result/share/dfeed/web/static/js/*.min.js ./web/static/js/ 2>/dev/null || true

	# Copy built dlang.org CSS/JS (but not source files from submodule)
	mkdir -p web/static/dlang.org/css web/static/dlang.org/js
	cp -f result/share/dfeed/web/static/dlang.org/css/*.min.css ./web/static/dlang.org/css/ 2>/dev/null || true
	cp -f result/share/dfeed/web/static/dlang.org/js/*.min.js ./web/static/dlang.org/js/ 2>/dev/null || true

	# Copy generated forum-template.html
	cp -f result/share/dfeed/web/static/dlang.org/forum-template.html ./web/static/dlang.org/ 2>/dev/null || true
fi

# Copy config files (especially generated groups.ini)
if [ -d result/share/dfeed/config ]; then
	echo "Copying config files..."
	# Only copy generated/built config files, not .sample files
	# to avoid overwriting local configuration
	if [ -f result/share/dfeed/config/groups.ini ]; then
		cp -f result/share/dfeed/config/groups.ini ./config/
	fi
fi

# Keep result symlink to prevent Nix from GC-ing dependencies
